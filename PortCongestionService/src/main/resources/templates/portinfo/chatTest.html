<!DOCTYPE html>
<html lang="ko" xmlns:th="http://thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Port Congestion Service Home</title>

    <!-- í˜ì´ì§€ css ì¶”ê°€ -->
    <link rel="stylesheet" th:href="@{/css/glv.css}" />
    <link rel="stylesheet" th:href="@{/css/liveChat.css}" />
    <script th:src="@{/script/jquery-3.7.1.min.js}"></script>
    <!-- ì›¹ì†Œì¼“ STOMP í”„ë¡œí† ì½œ script -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script th:src="@{/script/stomp.min.js}"></script>
    <script th:src="@{/script/liveChat.js}" defer></script>
    <script>
        const nav = document.querySelector('.global-navigation-bar');
        let lastScrollY = window.scrollY;

        $(function () {
            // ë¡œê·¸ì¸/íšŒì›ê°€ì… ì•¡ì…˜
            $(".log-in").on('click', function () {
                window.location.href = "/user/login";
            });
            $(".sign-up").on('click', function () {
                window.location.href = "/user/join";
            });
            $(".log-out").on('click', function () {
                window.location.href = "/user/logout";
            });
            $(".my-page").on('click', function () {
                // window.location.href = "/user/mypage";
            })
            // ìŠ¤í¬ë¡¤ ì•¡ì…˜ 
            $(document).on('scroll', () => {
                console.log(lastScrollY);
                if (window.scrollY > lastScrollY) { // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                    console.log("ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤");
                    $('.global-navigation-bar').addClass('hide');
                } else { // ìœ„ë¡œ ìŠ¤í¬ë¡¤
                    console.log("ìœ„ë¡œ ìŠ¤í¬ë¡¤");
                    $('.global-navigation-bar').removeClass('hide');
                }
                lastScrollY = window.scrollY;
            });

        });

        // ë³¸ë¬¸ ë™ì‘
        $(function () {
            // ì±„íŒ… ë©”ì„¸ì§€ ì…ë ¥
            $("#message-field").on('keyup', function () {
                let text = $("#message-field").val();
                if (text.length != 0) {
                    $("#img-change-to").attr('src', '/img/paper_airplane_white.svg');
                    $("#send-button").prop('disabled', false);
                } else {
                    $("#img-change-to").attr('src', '/img/paper_airplane_gray.svg');
                    $("#send-button").prop('disabled', true);
                }
            });

            // toggle ë™ì‘ - ì•ˆë¨¹í˜ 
            $(".slider").on('click', function () {
                $(this).siblings("input:checkbox").prop('checked', function (i, val) {
                    return !val;
                });
            });
        });

        // ë§ˆì§€ë§‰ ì±„íŒ… ì‹œê°„ ê³„ì‚° 
        function calculateTimeDifference() {
            const input = document.getElementById('lastChat');
            const lastChatDateStr = input.value;
            const lastChatDate = new Date(lastChatDateStr.split('/').reverse().join('-'));

            const now = new Date();
            const diff = now - lastChatDate; // ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ì°¨ì´

            const minutesPassed = Math.floor(diff / 60000); // ë°€ë¦¬ì´ˆë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜

            // ê²°ê³¼ë¥¼ í‘œì‹œí•  ìš”ì†Œ
            document.getElementById('last-chat').innerHTML(`Last chat ${minutesPassed} minutes ago`);
        }

        // 1ë¶„(60000 ë°€ë¦¬ì´ˆ)ë§ˆë‹¤ í•¨ìˆ˜ ì‹¤í–‰
        setInterval(calculateTimeDifference, 60000);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì´ˆ 1íšŒ ì‹¤í–‰
        calculateTimeDifference();



    </script>
</head>

<body>
    <div class="global-navigation-bar">
        <div class="navigation-menu">
            <div class="menu"><a th:href="@{/}">Home</a></div>
            <div class="menu"><a th:href="@{/portStatus}">Port Status</a></div>
            <div class="menu"><a th:href="@{/port}">Vessel Schedule</a></div>
            <div class="menu"><a th:href="@{/marineNews}">Marine News</a></div>
            <div class="menu"><a th:href="@{/subscription}">Subscription</a></div>
        </div>
        <div class="user-menu">
            <button class="log-in" sec:authorize="isAnonymous()">Log in</button>
            <button class="sign-up" sec:authorize="isAnonymous()">Sign up</button>
            <button class="log-out" sec:authorize="isAuthenticated()">Log out</button>
            <button class="my-page" sec:authorize="isAuthenticated()">My page</button>
        </div>
    </div>

    <!-- ë³¸ë¬¸ -->
    <input type="hidden" id="portId" value="SGSIN">
    <input type="hidden" id="user" value="ë…¸ì¬ì€">
    <input type="hidden" id="lastChat">
    <!-- <input type="hidden" id="user" th:value="@{authentication.name}"> -->
    <!-- ì±„íŒ…ë°© -->
    <div class="chat-window">
        <div class="chat-header">
            <!-- portcd ë°›ì•„ì„œ ë™ì ìœ¼ë¡œ ë³€ê²½ -->
            <div class="center-title">
                <div class="port-name">ğŸ‡­ğŸ‡° Hongkong Port</div>
                <div class="last-chat" id="last-chat">Last chat 30 minutes ago</div>
            </div>
            <div class="toggle-wrapper">
                <div class="chatbot-label">AI ChatbotğŸ¤–</div>
                <div class="toggle">
                    <input type="checkbox" id="toggle-slider">
                    <label for="toggle-slider">on/off</label>
                </div>
            </div>
        </div>
        <div class="chat-message-window">


        </div>
        <div class="chat-input-bar">
            <div class="emoji"><img th:src="@{/img/emoji.svg}" alt=""></div>
            <div class="text-field">
                <input type="text" id="message-field" name="message" placeholder="Start typing...">
            </div>
            <div class="send-box">
                <div class="mention"><img th:src="@{/img/mention.svg}" alt=""></div>
                <div class="send-button-container">
                    <button id="send-button" disabled>
                        <img id="img-change-to" th:src="@{/img/paper_airplane_gray.svg}" alt="">
                    </button>
                </div>
            </div>
        </div>
    </div>



</body>

</html>